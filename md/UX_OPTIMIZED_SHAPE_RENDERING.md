# UXæœ€é©åŒ–: å½¢çŠ¶ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆ¦ç•¥

## ğŸ¯ è¨­è¨ˆæ€æƒ³

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå½¢çŠ¶ã‚’é¸æŠã—ãŸã‚‰ã€å³åº§ã«è¡¨ç¤ºã™ã‚‹ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ç¢ºèªã¯æ¤œè¨¼ã®ã¿ã€‚**

---

## âŒ Before: æ‚ªã„UX

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ "square" ã‚’é¸æŠ
2. "Start Training" ã‚¯ãƒªãƒƒã‚¯
3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ â³
4. å­¦ç¿’ãƒ«ãƒ¼ãƒ—é–‹å§‹
5. SSE: env_config å—ä¿¡ â³
6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å½¢çŠ¶æ›´æ–°
7. ã‚„ã£ã¨ â–  (square) ãŒè¡¨ç¤ºã•ã‚Œã‚‹ âŒ é…ã„ï¼
```

**å•é¡Œ**: å­¦ç¿’é–‹å§‹å¾Œã«ã—ã‹å½¢çŠ¶ãŒåæ˜ ã•ã‚Œãªã„ â†’ UXãŒæ‚ªã„

---

## âœ… After: è‰¯ã„UX

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ "square" ã‚’é¸æŠ
   â””â”€ LLMStore.request.shape = "square"

2. "Start Training" ã‚¯ãƒªãƒƒã‚¯
   â””â”€ createNewEpisode({ shape: "square", ... })
      â””â”€ episodeConfig.shape = "square"
         â””â”€ å³åº§ã« â–  (square) ãŒè¡¨ç¤ºã•ã‚Œã‚‹ âœ… é€Ÿã„ï¼

3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ï¼ˆä¸¦è¡Œï¼‰
4. å­¦ç¿’ãƒ«ãƒ¼ãƒ—é–‹å§‹
5. SSE: env_config { shape: "square" }
   â””â”€ å½¢çŠ¶ã‚’æ¤œè¨¼:
      â”œâ”€ ä¸€è‡´ â†’ âœ… "env_config verified: shape matches (square)"
      â””â”€ ä¸ä¸€è‡´ â†’ âš ï¸ å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆé€šå¸¸ã¯ç™ºç”Ÿã—ãªã„ï¼‰
```

**æ”¹å–„**: 
- âœ… **å³åº§ã«è¡¨ç¤º**ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è¨­å®šã‚’ä¿¡é ¼ï¼‰
- âœ… **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§æ¤œè¨¼**ï¼ˆä¸‡ãŒä¸€ã®ä¸ä¸€è‡´ã«å¯¾å¿œï¼‰
- âœ… **é€šå¸¸ã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸è¦**ï¼ˆåŠ¹ç‡çš„ï¼‰

---

## ğŸ“ å®Ÿè£…

### 1. ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä½œæˆæ™‚ã«LLMã‚¿ãƒ–ã®è¨­å®šã‚’ä½¿ç”¨

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/features/marl/MARLModuleRefactored.tsx`

```typescript
// åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚
useEffect(() => {
  if (!episodeId) {
    import('@/store/useLLMStore').then(({ useLLMStore }) => {
      const llmConfig = useLLMStore.getState().request
      createNewEpisode({
        shape: llmConfig.shape,  // â† LLMã‚¿ãƒ–ã®è¨­å®š
        n_robot: llmConfig.n_robot,
        // ...
      })
    })
  }
}, [])

// å­¦ç¿’é–‹å§‹æ™‚
const handleToggleTraining = async () => {
  const llmStore = (await import('@/store/useLLMStore')).useLLMStore.getState()
  const llmConfig = llmStore.request
  
  await createNewEpisode({
    shape: llmConfig.shape,  // â† LLMã‚¿ãƒ–ã®è¨­å®š
    // ...
  })
  
  await startTraining(...)
}
```

### 2. SSEã§æ¤œè¨¼ã®ã¿ï¼ˆä¸ä¸€è‡´ã®å ´åˆã®ã¿æ›´æ–°ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/store/useMARLStore.ts`

```typescript
case 'env_config': {
  // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ç’°å¢ƒè¨­å®šã‚’å—ä¿¡ã—ã¦æ¤œè¨¼
  // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®è¨­å®šã¨ç•°ãªã‚‹å ´åˆã®ã¿æ›´æ–°ï¼ˆé€šå¸¸ã¯ä¸€è‡´ã™ã‚‹ã¯ãšï¼‰
  const currentShape = state.episodeConfig.shape
  
  if (currentShape !== event.shape) {
    // âš ï¸ ä¸ä¸€è‡´ï¼ï¼ˆé€šå¸¸ã¯ç™ºç”Ÿã—ãªã„ï¼‰
    console.warn('âš ï¸ Shape mismatch! Frontend:', currentShape, 'Backend:', event.shape)
    console.log('ğŸ”„ Re-rendering with backend shape:', event.shape)
    
    set({ episodeConfig: { ...newConfig, shape: event.shape } })
  } else {
    // âœ… ä¸€è‡´ï¼ˆé€šå¸¸ã¯ã“ã¡ã‚‰ï¼‰
    console.log('âœ… env_config verified: shape matches (', event.shape, ')')
    // æ›´æ–°ä¸è¦ â†’ å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãªã—
  }
  break
}
```

---

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 1: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼ˆå³åº§ï¼‰                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LLM Tab: "square" é¸æŠ                                        â”‚
â”‚   â†“                                                           â”‚
â”‚ useLLMStore.request.shape = "square"                         â”‚
â”‚   â†“                                                           â”‚
â”‚ "Start Training" ã‚¯ãƒªãƒƒã‚¯                                     â”‚
â”‚   â†“                                                           â”‚
â”‚ createNewEpisode({ shape: "square", ... })                   â”‚
â”‚   â†“                                                           â”‚
â”‚ useMARLStore.episodeConfig.shape = "square"                  â”‚
â”‚   â†“                                                           â”‚
â”‚ RobotVisualization re-render                                 â”‚
â”‚   â†“                                                           â”‚
â”‚ â–  (square) è¡¨ç¤º âš¡ å³åº§ï¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€šä¿¡ï¼ˆä¸¦è¡Œï¼‰                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /episode { shape: "square", ... }                       â”‚
â”‚   â†“                                                           â”‚
â”‚ Backend: SwarmEnv(shape="square")                            â”‚
â”‚   â†“                                                           â”‚
â”‚ POST /train                                                  â”‚
â”‚   â†“                                                           â”‚
â”‚ Backend: _train_loop é–‹å§‹                                     â”‚
â”‚   â†“                                                           â”‚
â”‚ SSE: env_config { shape: "square", ... } (1å›ã ã‘)           â”‚
â”‚   â†“                                                           â”‚
â”‚ Frontend: æ¤œè¨¼                                                â”‚
â”‚   â”œâ”€ "square" == "square" â†’ âœ… ä¸€è‡´ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰            â”‚
â”‚   â””â”€ "square" != "circle" â†’ âš ï¸ å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆç¨€ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase 3: å­¦ç¿’ä¸­ï¼ˆç¶™ç¶šï¼‰                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SSE: tick { positions: [...], ... } (æ¯ã‚¹ãƒ†ãƒƒãƒ—)            â”‚
â”‚   â†“                                                           â”‚
â”‚ Frontend: ãƒ­ãƒœãƒƒãƒˆä½ç½®ã®ã¿æ›´æ–°                                â”‚
â”‚   â†“                                                           â”‚
â”‚ å½¢çŠ¶ã¯å¤‰ã‚ã‚‰ãªã„ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸è¦ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ï¼ˆæ­£å¸¸ç³»ï¼‰

### ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰
```
ğŸ”„ Creating initial episode with LLM config: circle
ğŸ”„ Creating new episode with config: { shape: 'circle', ... }
âœ… Episode created: ep-xxx
ğŸ¨ UI updated: shape = circle
```

### å½¢çŠ¶å¤‰æ›´ + å­¦ç¿’é–‹å§‹
```
(LLM Tab ã§ "square" é¸æŠ)

ğŸ”„ Creating episode with shape: square | robots: 30
ğŸ”„ Creating new episode with config: { shape: 'square', ... }
âœ… Episode created: ep-yyy
ğŸ¨ UI updated: shape = square  â† å³åº§ã«è¡¨ç¤ºï¼

(ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€šä¿¡ä¸­...)

âœ… Training started: ep-yyy with LLM: true
âœ… env_config verified: shape matches ( square )  â† æ¤œè¨¼OK
```

### ä¸ä¸€è‡´ãŒç™ºç”Ÿã—ãŸå ´åˆï¼ˆç¨€ï¼‰
```
ğŸ”„ Creating episode with shape: square | robots: 30
ğŸ¨ UI updated: shape = square  â† å³åº§ã«è¡¨ç¤º

(ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒä½•ã‚‰ã‹ã®ç†ç”±ã§ circle ã‚’è¿”ã—ãŸå ´åˆ)

âš ï¸ Shape mismatch! Frontend: square Backend: circle
ğŸ”„ Re-rendering with backend shape: circle
ğŸ¨ UI updated: shape = circle  â† ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«å¾“ã†
```

---

## ğŸ¯ ãƒ¡ãƒªãƒƒãƒˆ

### 1. **å³åº§ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯** âš¡
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸå½¢çŠ¶ãŒå³åº§ã«è¡¨ç¤ºã•ã‚Œã‚‹
- å­¦ç¿’é–‹å§‹ã‚’å¾…ã¤å¿…è¦ãªã—

### 2. **ä¿¡é ¼ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿** âœ…
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç¢ºèªã‚’å—ã‘å–ã‚‹
- ä¸‡ãŒä¸€ã®ä¸ä¸€è‡´ã«ã‚‚å¯¾å¿œ

### 3. **åŠ¹ç‡çš„ãªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°** ğŸš€
- é€šå¸¸ã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸è¦
- SSEã‚¤ãƒ™ãƒ³ãƒˆã§çŠ¶æ…‹ãŒå¤‰ã‚ã‚‰ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

### 4. **ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„** ğŸ”
- ä¸ä¸€è‡´ãŒç™ºç”Ÿã—ãŸå ´åˆã¯è­¦å‘Šãƒ­ã‚°
- é€šå¸¸ã¯ç°¡æ½”ãªãƒ­ã‚°ã®ã¿

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### ã‚·ãƒŠãƒªã‚ª1: æ­£å¸¸ç³»ï¼ˆå½¢çŠ¶ä¸€è‡´ï¼‰

1. LLM Tab: "circle" é¸æŠ
2. MARL Tab: å³åº§ã« â— è¡¨ç¤º âœ…
3. "Start Training" ã‚¯ãƒªãƒƒã‚¯
4. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«: `âœ… env_config verified: shape matches (circle)`
5. å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãªã— âœ…

### ã‚·ãƒŠãƒªã‚ª2: å½¢çŠ¶å¤‰æ›´

1. LLM Tab: "square" é¸æŠ
2. MARL Tab: "Start Training" ã‚¯ãƒªãƒƒã‚¯
3. **å³åº§ã« â–  è¡¨ç¤º** âš¡ â† é‡è¦ï¼
4. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«: `âœ… env_config verified: shape matches (square)`
5. å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãªã— âœ…

### ã‚·ãƒŠãƒªã‚ª3: ä¸ä¸€è‡´ï¼ˆäººå·¥çš„ã«ãƒ†ã‚¹ãƒˆï¼‰

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´ã—ã¦ãƒ†ã‚¹ãƒˆï¼š
```python
# backend/app/main.py
store["metrics"]["timeline"].append({
    "type": "env_config",
    "shape": "circle",  # â† å¼·åˆ¶çš„ã« circle
    # ...
})
```

1. LLM Tab: "square" é¸æŠ
2. MARL Tab: "Start Training" ã‚¯ãƒªãƒƒã‚¯
3. æœ€åˆã¯ â–  è¡¨ç¤º
4. SSEå—ä¿¡å¾Œã« â— ã«å¤‰ã‚ã‚‹
5. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«: `âš ï¸ Shape mismatch! Frontend: square Backend: circle`

---

## ğŸ‰ ã¾ã¨ã‚

**"å¤šåˆ†åˆã£ã¦ã„ã‚‹ã ã‚ã†"ã§å³åº§ã«è¡¨ç¤ºã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§æ¤œè¨¼ã™ã‚‹ã€‚**

ã“ã®æˆ¦ç•¥ã«ã‚ˆã‚Šï¼š
- âœ… **UXãŒå¤§å¹…ã«å‘ä¸Š**ï¼ˆå³åº§ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
- âœ… **ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ä¿è¨¼**ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§æ¤œè¨¼ï¼‰
- âœ… **åŠ¹ç‡çš„**ï¼ˆé€šå¸¸ã¯å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸è¦ï¼‰

æœ€é«˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¨å …ç‰¢æ€§ã‚’ä¸¡ç«‹ï¼ ğŸš€

