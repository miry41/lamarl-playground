# å½¢çŠ¶è¡¨ç¤ºä¿®æ­£ - æœ€çµ‚ç‰ˆ

## ğŸ› æ ¹æœ¬åŸå› 

### å•é¡Œ1: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å½¢çŠ¶ç”Ÿæˆé–¢æ•°ã«`square`ã¨`triangle`ãŒæœªå®Ÿè£…
**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/utils/shapeGenerator.ts`
- `switch`æ–‡ã«`case 'square'`ã¨`case 'triangle'`ãŒãªã‹ã£ãŸ
- `default`ã‚±ãƒ¼ã‚¹ã§å¸¸ã«å††ãŒè¿”ã•ã‚Œã¦ã„ãŸ

### å•é¡Œ2: åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ç©ºã®è¨­å®šã§ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä½œæˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/features/marl/MARLModuleRefactored.tsx`
- `useEffect`ã§`createNewEpisode()`ã‚’å¼•æ•°ãªã—ã§å‘¼ã‚“ã§ã„ãŸ
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®'circle'ãŒä½¿ã‚ã‚Œã¦ã„ãŸ

---

## âœ… ä¿®æ­£å†…å®¹

### 1. `shapeGenerator.ts`ã«`square`ã¨`triangle`ã‚’è¿½åŠ 

```typescript
case 'square': {
  const halfSize = Math.floor(gridSize * 0.275)
  const startX = Math.floor(centerX - halfSize)
  const endX = Math.floor(centerX + halfSize)
  const startY = Math.floor(centerY - halfSize)
  const endY = Math.floor(centerY + halfSize)
  for (let i = startX; i < endX; i++) {
    for (let j = startY; j < endY; j++) {
      if (i >= 0 && i < gridSize && j >= 0 && j < gridSize) {
        cells.push({ x: i, y: j })
      }
    }
  }
  break
}

case 'triangle': {
  const r = gridSize / 4
  const h = Math.floor(r * 1.2)
  const w = Math.floor(r * 1.0)
  const centerYStart = Math.floor(centerY - r)
  
  for (let i = 0; i < h; i++) {
    const lineWidth = Math.floor(w * (h - i) / h)
    if (lineWidth > 0) {
      const startX = Math.floor(centerX - lineWidth)
      const endX = Math.floor(centerX + lineWidth)
      const y = centerYStart + i
      if (y >= 0 && y < gridSize) {
        for (let x = startX; x <= endX; x++) {
          if (x >= 0 && x < gridSize) {
            cells.push({ x, y })
          }
        }
      }
    }
  }
  break
}
```

### 2. åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚ã«LLMã‚¿ãƒ–ã®è¨­å®šã‚’ä½¿ç”¨

**Before (ä¿®æ­£å‰)**:
```typescript
useEffect(() => {
  if (!episodeId) {
    createNewEpisode()  // âŒ ç©ºã®è¨­å®š â†’ circle
  }
}, [])
```

**After (ä¿®æ­£å¾Œ)**:
```typescript
useEffect(() => {
  if (!episodeId) {
    // LLMã‚¿ãƒ–ã®è¨­å®šã‚’ä½¿ã£ã¦ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ä½œæˆ
    import('@/store/useLLMStore').then(({ useLLMStore }) => {
      const llmConfig = useLLMStore.getState().request
      console.log('ğŸ”„ Creating initial episode with LLM config:', llmConfig.shape)
      createNewEpisode({
        shape: llmConfig.shape,
        n_robot: llmConfig.n_robot,
        r_sense: llmConfig.r_sense,
        r_avoid: llmConfig.r_avoid,
        n_hn: llmConfig.n_hn,
        n_hc: llmConfig.n_hc,
      })
    })
  }
}, [])
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®ç¢ºèª

### ã‚¿ã‚¤ãƒŸãƒ³ã‚°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ï¼ˆMARLã‚¿ãƒ–ãƒã‚¦ãƒ³ãƒˆï¼‰                      â”‚
â”‚    â””â”€ LLMã‚¿ãƒ–ã®è¨­å®šã‚’å–å¾—                               â”‚
â”‚       â””â”€ createNewEpisode({ shape: "circle", ... })    â”‚
â”‚          â””â”€ episodeConfig.shape = "circle"             â”‚
â”‚             â””â”€ RobotVisualizationè¡¨ç¤º â— (circle) âœ…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒLLMã‚¿ãƒ–ã§å½¢çŠ¶ã‚’å¤‰æ›´                        â”‚
â”‚    â””â”€ useLLMStore.request.shape = "square"             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ"â–¶ Start Training"ã‚¯ãƒªãƒƒã‚¯                 â”‚
â”‚    â””â”€ LLMã‚¿ãƒ–ã®è¨­å®šã‚’å–å¾—                               â”‚
â”‚       â””â”€ createNewEpisode({ shape: "square", ... })    â”‚
â”‚          â””â”€ episodeConfig.shape = "square"             â”‚
â”‚             â””â”€ RobotVisualizationè¡¨ç¤º â–  (square) âœ…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å­¦ç¿’é–‹å§‹ï¼ˆ1å›ã ã‘ï¼‰                                   â”‚
â”‚    â””â”€ SSE: env_config { shape: "square", ... }        â”‚
â”‚       â””â”€ episodeConfigæ›´æ–°ï¼ˆç¢ºèªï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å­¦ç¿’ä¸­ï¼ˆæ¯ã‚¹ãƒ†ãƒƒãƒ—ï¼‰                                  â”‚
â”‚    â””â”€ SSE: tick { positions: [...], ... }             â”‚
â”‚       â””â”€ ãƒ­ãƒœãƒƒãƒˆä½ç½®ã®ã¿æ›´æ–°                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ä½œæˆæ™‚ã«å½¢çŠ¶ãŒæ±ºã¾ã‚‹**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§`episodeConfig`ã«è¨­å®š
   - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ã—ã¦ç’°å¢ƒã‚’ä½œæˆ
   - **å³åº§ã«UIã«åæ˜ **

2. **SSEã®`env_config`ã¯ç¢ºèªç”¨**
   - å­¦ç¿’é–‹å§‹æ™‚ã«**1å›ã ã‘**é€ä¿¡
   - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å®Ÿéš›ã®è¨­å®šã‚’ç¢ºèª
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®`episodeConfig`ã‚’æ›´æ–°

3. **å­¦ç¿’ä¸­ã¯ãƒ­ãƒœãƒƒãƒˆä½ç½®ã®ã¿**
   - `tick`ã‚¤ãƒ™ãƒ³ãƒˆã§`positions`ã¨`velocities`
   - å½¢çŠ¶ã¯å¤‰ã‚ã‚‰ãªã„ï¼ˆå†é€ä¿¡ã—ãªã„ï¼‰

---

## âœ… çµæœ

### Before (ä¿®æ­£å‰)
```
Page Load â†’ circle (default)
LLM Tab: "square" selected
Training Start â†’ â— (circle) âŒ
```

### After (ä¿®æ­£å¾Œ)
```
Page Load â†’ â— (circle from LLM Tab)
LLM Tab: "square" selected
Training Start â†’ â–  (square) âœ…
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

1. **ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å®Œå…¨ãƒªãƒ­ãƒ¼ãƒ‰** (Ctrl+Shift+R)

2. **MARLã‚¿ãƒ–ã‚’é–‹ã**
   - é»„è‰²ã„ãƒ‡ãƒãƒƒã‚°ãƒœãƒƒã‚¯ã‚¹: `episodeConfig.shape = circle`
   - å¯è¦–åŒ–: â— (å††)

3. **LLMã‚¿ãƒ–ã«ç§»å‹•**
   - Shape: "Square" ã‚’é¸æŠ

4. **MARLã‚¿ãƒ–ã«æˆ»ã‚‹**
   - "â–¶ Start Training" ã‚¯ãƒªãƒƒã‚¯

5. **ç¢ºèª**
   - é»„è‰²ã„ãƒ‡ãƒãƒƒã‚°ãƒœãƒƒã‚¯ã‚¹: `episodeConfig.shape = square`
   - å¯è¦–åŒ–: â–  (æ­£æ–¹å½¢) âœ…

---

## ğŸ‰ å®Œäº†ï¼

**LLMã‚¿ãƒ–ã§é¸æŠã—ãŸå½¢çŠ¶ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¾ã™ï¼**

- âœ… åˆå›ãƒã‚¦ãƒ³ãƒˆæ™‚: LLMã‚¿ãƒ–ã®è¨­å®šã‚’ä½¿ç”¨
- âœ… å­¦ç¿’é–‹å§‹å‰: é¸æŠã—ãŸå½¢çŠ¶ãŒè¡¨ç¤º
- âœ… å­¦ç¿’ä¸­: SSEã¯`env_config`ã‚’1å›ã ã‘é€ä¿¡ï¼ˆåŠ¹ç‡çš„ï¼‰

